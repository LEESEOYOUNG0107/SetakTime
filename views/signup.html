<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SetakTime - 회원가입</title>
    <link rel="stylesheet" href="/style/signup.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Noto+Sans+KR:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body>
    <header>
        <div class="header-container">
            <h1 class="logo">SetakTime</h1>
            <nav>
                <ul>
                    <li><a href="/main.html">홈</a></li>
                    <li><a href="#">세탁 예약/취소</a></li>
                    <li><a href="/login.html">로그인</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="signup-container">
            <h2 class="main-logo">SetakTime</h2>
            <div class="signup-box">
                <h3>sign up</h3>
                <form id="signupForm">
                    <input type="text" name="userid" placeholder="Id" required>
                    <input type="password" name="password" placeholder="pw" required>
                    <input type="text" name="username" placeholder="name" required>
                    <input type="text" name="roomnumber" placeholder="room number">
                    <button type="submit" class="btn-ok">Ok</button>
                </form>

                <script>
                    const form = document.getElementById('signupForm');

                    form.addEventListener('submit', function (e) {
                        e.preventDefault(); // 기본 제출 막기

                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());

                        // --- 입력값 유효성 검사 ---
                        const { userid, password, username, roomnumber } = data;

                        // 1. 아이디 검사: 4~15자, 영문 소문자, 숫자만
                        const useridRegex = /^[a-z0-9]{4,15}$/;
                        if (!useridRegex.test(userid)) {
                            alert('아이디는 4~15자의 영문 소문자와 숫자만 사용할 수 있습니다.');
                            return;
                        }

                        // 2. 비밀번호 검사: 8~20자, 대/소문자, 숫자, 특수문자(!@#$%^&*) 각 1개 이상 포함
                        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{8,20}$/;
                        if (!passwordRegex.test(password)) {
                            alert('비밀번호는 8~20자 길이로, 영문 대/소문자, 숫자, 특수문자(!@#$%^&*)를 각각 하나 이상 포함해야 합니다.');
                            return;
                        }

                        // 3. 이름 검사: 2~5자, 한글만
                        const usernameRegex = /^[가-힣]{2,5}$/;
                        if (!usernameRegex.test(username)) {
                            alert('이름은 2~5자의 한글만 사용할 수 있습니다.');
                            return;
                        }

                        // 4. 호실 번호 검사
                        const roomNum = parseInt(roomnumber, 10);
                        if (isNaN(roomNum) || roomNum < 401 || roomNum > 418) {
                            alert('호실 번호는 401부터 418까지만 입력 가능합니다.');
                            return;
                        }

                        fetch('/signup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        })
                            .then(res => {
                                if (!res.ok) {
                                    // 서버에서 보낸 에러 메시지를 그대로 사용하기 위해 text()로 받음
                                    return res.text().then(text => { throw new Error(text) });
                                }
                                return res.text();
                            })
                            .then(resText => {
                                if (resText === 'success') {
                                    alert('회원가입 성공!');
                                    window.location.href = '/login.html'; // 올바른 로그인 페이지로 이동
                                } else {
                                    alert('회원가입 실패: ' + resText);
                                }
                            })
                            .catch(err => {
                                console.error(err);
                                alert('회원가입 실패: ' + err.message);
                            });
                    });
                </script>


            </div>
        </div>
    </main>
</body>

</html>